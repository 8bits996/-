// ==UserScript==
// @name         23.04.09-淘宝锁选项脚本-锁命名变量并跳转购买页
// @namespace    http://tampermonkey.net/
// @version      0.5
// @description  用于识别淘宝域名并根据域名触发动作
// @author       chick
// @match        https://*.taobao.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    function handleTaobaoDomain(domain) {
        if (domain.includes('item.taobao.com')) {
            handleItemPage();
        } else if (domain.includes('buy.taobao.com')) {
            handleClickSubmitOrder();
        } else {
            handleOtherPages();
        }
    }

    function handleItemPage() {
        console.log('商品页面');
        selectItemOption(0,'颜色分类', 4);
        selectItemOption(2,'轴体名称', 5, true);
    }

    function handleOtherPages() {
        console.log('其他页面');
    }

    function findItemOptions(element, name) {
        if (element.hasAttribute('data-property') && element.getAttribute('data-property') === name) {
            return element;
        }

        for (let i = 0; i < element.children.length; i++) {
            const result = findItemOptions(element.children[i], name);
            if (result) {
                return result;
            }
        }

        return null;
    }

    // 选项种类-选项名字-选项索引-是否触发点击
    function selectItemOption(classIndex, name, optionIndex, ifclick = false) {
        const itemOptionSelector = 'dl.J_Prop.tb-prop';

        const attemptSelection = () => {
            const baseElements = document.querySelectorAll(itemOptionSelector);

            for (let i = classIndex; i < baseElements.length; i++) {
                const itemOptions = findItemOptions(baseElements[i], name);

                if (itemOptions) {
                    const clickableElementSelector = `li:nth-child(${optionIndex}) a`;
                    const clickableElement = itemOptions.querySelector(clickableElementSelector);

                    if (clickableElement) {
                        clickableElement.click();
                        const selectedItem = itemOptions.querySelector('li.tb-selected a');

                        if (selectedItem === clickableElement) {
                            console.log(`第 ${optionIndex} 个商品选项`);
                            clearInterval(waitForSelection);
                            if(ifclick){
                                clickBuyNow();
                            }
                            break;
                        }
                    } else {
                        console.warn(`无法选中，请检查页面结构`);
                    }
                }
            }
        };

        const waitForSelection = setInterval(attemptSelection, 0);
    }

    function clickBuyNow() {
        const buyNowButtonSelector = 'a.J_LinkBuy';
        let interval;

        const checkButtonVisibility = () => {
            const buyNowButton = document.querySelector(buyNowButtonSelector);
            const isVisible = (buyNowButton && buyNowButton.offsetParent !== null);

            if (isVisible) {
                buyNowButton.click();
                console.log('点击立即购买');
                clearInterval(interval);
            }
        };

        interval = setInterval(checkButtonVisibility, 0);
    }

    function handleClickSubmitOrder() {
        console.log('提交订单页面');
        clickSubmitOrder();
    }

    function clickSubmitOrder() {
        const submitOrderButtonSelector = '.go-btn';

        const waitForSubmitOrderButton = setInterval(() => {
            const submitOrderButton = document.querySelector(submitOrderButtonSelector);

            if (submitOrderButton) {
                clearInterval(waitForSubmitOrderButton);
                // submitOrderButton.click();
                console.log('点击提交订单');
            }
        }, 0);
    }

    const currentDomain = window.location.hostname;
    handleTaobaoDomain(currentDomain);
})();